# fs2-quartz
Quarts scheduler library using fs2

### Import
```sbt
"com.itv" %% "fs2-quartz-core"
"com.itv" %% "fs2-quartz-extruder"
```

The project uses a quartz scheduler, and as scheduled messages are generated by Quartz they are
decoded and put onto an `fs2.concurrent.Queue`. The components are:
* a `MessageScheduler[F[_], J, A]` which schedules and receives corresponding messages
* a `JobDataEncoder[J]` which encodes job data in a map for the given job
* a single job class (`PublishCallbackJob`) which is triggered by quartz when a scheduled task occurs
* a `JobDecoder[A]` which decodes the incoming message data map into an `A`
* the resulting `A` is put onto the provided `fs2.concurrent.Queue[F, A]`

*** Quite often `J` and `A` will be the same type, usually a parent sealed trait

## Usage:

### Creating a scheduler
```scala
import java.util.concurrent.Executors
import cats.effect._
import com.itv.scheduler.{QuartzProperties, QuartzTaskScheduler}

val quartzProperties = QuartzProperties(new java.util.Properties())
val blocker = Blocker.liftExecutorService(Executors.newFixedThreadPool(8))
val schedulerResource: Resource[IO, MessageScheduler[IO, J, A]] =
  QuartzTaskScheduler[IO, J, A](blocker, quartzProperties)
```

### Encoding/decoding job details
The `extruder` project provides the ability to encode/decode an object as a `Map[String, String]`, which works perfectly
for putting data into the quzrtz job data map
```scala
import cats.implicits._
import com.itv.scheduler.extruder.implicits._
import _root_.extruder.core._
import _root_.extruder.map._

sealed trait ParentTestJob
case object ChildObjectJob     extends ParentTestJob
case class UserJob(id: String) extends ParentTestJob

object ParentTestJob {
  implicit val jobDataEncoder: JobDataEncoder[ParentTestJob] = deriveEncoder[ParentTestJob]
  implicit val jobDecoder: JobDecoder[ParentTestJob]         = deriveDecoder[ParentTestJob]
}
```

### Using the scheduler
```scala
import java.time.Instant
import org.quartz.{CronExpression, JobKey, TriggerKey}

def scheduleCronJob(scheduler: MessageScheduler[IO, ParentTestJob, ParentTestJob]): IO[Option[Instant]] =
  scheduler.scheduleJob(
    JobKey.jobKey("child-object-job"),
    ChildObjectJob,
    TriggerKey.triggerKey("cron-test-trigger"),
    CronScheduledJob(new CronExpression("* * * ? * *"))
  )
            
def scheduleSingleJob(scheduler: MessageScheduler[IO, ParentTestJob, ParentTestJob]): IO[Option[Instant]] =
  scheduler.scheduleJob(
    JobKey.jobKey("single-user-job"),
    UserJob("user-123"),
    TriggerKey.triggerKey("scheduled-single-test-trigger"),
    JobScheduledAt(Instant.now.plusSeconds(2))
  )
```
